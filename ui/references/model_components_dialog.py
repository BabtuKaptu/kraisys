"""Model components management dialog"""
from PyQt6.QtWidgets import (
    QDialog, QVBoxLayout, QHBoxLayout, QPushButton, QTableWidget,
    QTableWidgetItem, QComboBox, QSpinBox, QDoubleSpinBox, QCheckBox,
    QLabel, QLineEdit, QTextEdit, QMessageBox, QHeaderView, QTabWidget,
    QWidget, QGroupBox, QGridLayout
)
from PyQt6.QtCore import Qt
import psycopg2.extras
from database.connection import DatabaseConnection


class ModelComponentsDialog(QDialog):
    """–î–∏–∞–ª–æ–≥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –º–æ–¥–µ–ª–∏"""

    def __init__(self, model_id: int, model_article: str = "", parent=None):
        super().__init__(parent)
        self.model_id = model_id
        self.model_article = model_article
        self.db = DatabaseConnection()

        # –î–∞–Ω–Ω—ã–µ
        self.cutting_parts = []
        self.materials = []
        self.components = []

        self.setup_ui()
        self.load_data()

    def setup_ui(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        self.setWindowTitle(f"–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–æ–¥–µ–ª–∏ {self.model_article}")
        self.setModal(True)
        self.resize(1200, 700)

        layout = QVBoxLayout(self)

        # –¢–∞–±—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        self.tabs = QTabWidget()

        # –í–∫–ª–∞–¥–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∫—Ä–æ—è
        self.cutting_tab = QWidget()
        self.setup_cutting_tab()
        self.tabs.addTab(self.cutting_tab, "–î–µ—Ç–∞–ª–∏ –∫—Ä–æ—è")

        # –í–∫–ª–∞–¥–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
        self.materials_tab = QWidget()
        self.setup_materials_tab()
        self.tabs.addTab(self.materials_tab, "–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ —Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞")

        # –í–∫–ª–∞–¥–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        self.custom_tab = QWidget()
        self.setup_custom_tab()
        self.tabs.addTab(self.custom_tab, "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã")

        layout.addWidget(self.tabs)

        # –ö–Ω–æ–ø–∫–∏
        buttons = QHBoxLayout()
        self.btn_save = QPushButton("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å")
        self.btn_calculate = QPushButton("üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å")
        self.btn_close = QPushButton("–ó–∞–∫—Ä—ã—Ç—å")

        self.btn_save.clicked.connect(self.save_components)
        self.btn_calculate.clicked.connect(self.calculate_costs)
        self.btn_close.clicked.connect(self.close)

        buttons.addWidget(self.btn_save)
        buttons.addWidget(self.btn_calculate)
        buttons.addStretch()
        buttons.addWidget(self.btn_close)

        layout.addLayout(buttons)

    def setup_cutting_tab(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∫–ª–∞–¥–∫–∏ –¥–µ—Ç–∞–ª–µ–π –∫—Ä–æ—è"""
        layout = QVBoxLayout(self.cutting_tab)

        # –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        toolbar = QHBoxLayout()

        self.btn_add_cutting = QPushButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å")
        self.btn_remove_cutting = QPushButton("‚ûñ –£–¥–∞–ª–∏—Ç—å")
        self.btn_add_cutting.clicked.connect(self.add_cutting_part)
        self.btn_remove_cutting.clicked.connect(self.remove_cutting_part)

        toolbar.addWidget(self.btn_add_cutting)
        toolbar.addWidget(self.btn_remove_cutting)
        toolbar.addStretch()

        layout.addLayout(toolbar)

        # –¢–∞–±–ª–∏—Ü–∞ –¥–µ—Ç–∞–ª–µ–π –∫—Ä–æ—è
        self.cutting_table = QTableWidget()
        self.cutting_table.setColumnCount(5)
        self.cutting_table.setHorizontalHeaderLabels([
            "–ö–æ–¥", "–ù–∞–∑–≤–∞–Ω–∏–µ", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", "–ï–¥–∏–Ω–∏—Ü–∞", "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ"
        ])

        header = self.cutting_table.horizontalHeader()
        header.setSectionResizeMode(1, QHeaderView.ResizeMode.Stretch)

        layout.addWidget(self.cutting_table)

    def setup_materials_tab(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∫–ª–∞–¥–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤"""
        layout = QVBoxLayout(self.materials_tab)

        # –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        toolbar = QHBoxLayout()

        self.btn_add_material = QPushButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª")
        self.btn_remove_material = QPushButton("‚ûñ –£–¥–∞–ª–∏—Ç—å")
        self.btn_add_material.clicked.connect(self.add_material)
        self.btn_remove_material.clicked.connect(self.remove_material)

        toolbar.addWidget(self.btn_add_material)
        toolbar.addWidget(self.btn_remove_material)
        toolbar.addStretch()

        layout.addLayout(toolbar)

        # –¢–∞–±–ª–∏—Ü–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
        self.materials_table = QTableWidget()
        self.materials_table.setColumnCount(6)
        self.materials_table.setHorizontalHeaderLabels([
            "–ö–æ–¥", "–ù–∞–∑–≤–∞–Ω–∏–µ", "–†–∞—Å—Ö–æ–¥ %", "–ê–±—Å. —Ä–∞—Å—Ö–æ–¥", "–ï–¥–∏–Ω–∏—Ü–∞", "–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ"
        ])

        header = self.materials_table.horizontalHeader()
        header.setSectionResizeMode(1, QHeaderView.ResizeMode.Stretch)

        layout.addWidget(self.materials_table)

    def setup_custom_tab(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∫–ª–∞–¥–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"""
        layout = QVBoxLayout(self.custom_tab)

        # –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        toolbar = QHBoxLayout()

        self.btn_add_custom = QPushButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç")
        self.btn_remove_custom = QPushButton("‚ûñ –£–¥–∞–ª–∏—Ç—å")
        self.btn_add_custom.clicked.connect(self.add_custom_component)
        self.btn_remove_custom.clicked.connect(self.remove_custom_component)

        toolbar.addWidget(self.btn_add_custom)
        toolbar.addWidget(self.btn_remove_custom)
        toolbar.addStretch()

        layout.addLayout(toolbar)

        # –¢–∞–±–ª–∏—Ü–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        self.custom_table = QTableWidget()
        self.custom_table.setColumnCount(5)
        self.custom_table.setHorizontalHeaderLabels([
            "–ù–∞–∑–≤–∞–Ω–∏–µ", "–ì—Ä—É–ø–ø–∞", "–†–∞—Å—Ö–æ–¥", "–ï–¥–∏–Ω–∏—Ü–∞", "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ"
        ])

        header = self.custom_table.horizontalHeader()
        header.setSectionResizeMode(0, QHeaderView.ResizeMode.Stretch)

        layout.addWidget(self.custom_table)

    def load_data(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö"""
        self.load_cutting_parts()
        self.load_materials()
        self.load_model_components()

    def load_cutting_parts(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∫—Ä–æ—è"""
        try:
            conn = self.db.get_connection()
            if not conn:
                return

            cursor = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
            cursor.execute("""
                SELECT id, code, name, category, default_qty, unit, notes
                FROM cutting_parts
                WHERE is_active = true AND is_cutting = true
                ORDER BY code
            """)

            self.cutting_parts = cursor.fetchall()
            cursor.close()
            self.db.put_connection(conn)

        except Exception as e:
            print(f"Error loading cutting parts: {e}")

    def load_materials(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤"""
        try:
            conn = self.db.get_connection()
            if not conn:
                return

            cursor = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
            cursor.execute("""
                SELECT id, code, name, material_type, unit, price
                FROM materials
                WHERE is_active = true
                ORDER BY name
            """)

            self.materials = cursor.fetchall()
            cursor.close()
            self.db.put_connection(conn)

        except Exception as e:
            print(f"Error loading materials: {e}")

    def load_model_components(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –º–æ–¥–µ–ª–∏"""
        try:
            conn = self.db.get_connection()
            if not conn:
                return

            cursor = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
            cursor.execute("""
                SELECT id, component_name, component_group,
                       consumption_percent, absolute_consumption,
                       unit, is_optional, notes
                FROM model_components
                WHERE model_id = %s
                ORDER BY sort_order, component_name
            """, (self.model_id,))

            components = cursor.fetchall()
            cursor.close()
            self.db.put_connection(conn)

            # –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º
            for comp in components:
                if comp['component_group'] == 'cutting':
                    self.add_cutting_to_table(comp)
                elif comp['component_group'] == 'material':
                    self.add_material_to_table(comp)
                else:
                    self.add_custom_to_table(comp)

        except Exception as e:
            print(f"Error loading model components: {e}")

    def add_cutting_to_table(self, component):
        """–î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å –∫—Ä–æ—è –≤ —Ç–∞–±–ª–∏—Ü—É"""
        row = self.cutting_table.rowCount()
        self.cutting_table.insertRow(row)

        # –ù–∞—Ö–æ–¥–∏–º –¥–µ—Ç–∞–ª—å –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
        part_info = None
        for part in self.cutting_parts:
            if part['name'] == component['component_name']:
                part_info = part
                break

        self.cutting_table.setItem(row, 0, QTableWidgetItem(
            part_info['code'] if part_info else ""
        ))
        self.cutting_table.setItem(row, 1, QTableWidgetItem(
            component['component_name']
        ))

        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
        qty_spin = QSpinBox()
        qty_spin.setMinimum(1)
        qty_spin.setMaximum(100)
        qty_spin.setValue(int(component['absolute_consumption'] or 1))
        self.cutting_table.setCellWidget(row, 2, qty_spin)

        self.cutting_table.setItem(row, 3, QTableWidgetItem(
            component['unit'] or "—à—Ç"
        ))
        self.cutting_table.setItem(row, 4, QTableWidgetItem(
            component['notes'] or ""
        ))

    def add_material_to_table(self, component):
        """–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª –≤ —Ç–∞–±–ª–∏—Ü—É"""
        row = self.materials_table.rowCount()
        self.materials_table.insertRow(row)

        # –ù–∞—Ö–æ–¥–∏–º –º–∞—Ç–µ—Ä–∏–∞–ª –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
        mat_info = None
        for mat in self.materials:
            if mat['name'] == component['component_name']:
                mat_info = mat
                break

        self.materials_table.setItem(row, 0, QTableWidgetItem(
            mat_info['code'] if mat_info else ""
        ))
        self.materials_table.setItem(row, 1, QTableWidgetItem(
            component['component_name']
        ))

        # –ü—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π —Ä–∞—Å—Ö–æ–¥
        percent_spin = QDoubleSpinBox()
        percent_spin.setMinimum(0)
        percent_spin.setMaximum(200)
        percent_spin.setSuffix(" %")
        percent_spin.setValue(float(component['consumption_percent'] or 0))
        self.materials_table.setCellWidget(row, 2, percent_spin)

        # –ê–±—Å–æ–ª—é—Ç–Ω—ã–π —Ä–∞—Å—Ö–æ–¥
        abs_spin = QDoubleSpinBox()
        abs_spin.setMinimum(0)
        abs_spin.setMaximum(1000)
        abs_spin.setDecimals(3)
        abs_spin.setValue(float(component['absolute_consumption'] or 0))
        self.materials_table.setCellWidget(row, 3, abs_spin)

        self.materials_table.setItem(row, 4, QTableWidgetItem(
            component['unit'] or ""
        ))

        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
        optional_check = QCheckBox()
        optional_check.setChecked(component['is_optional'] or False)
        self.materials_table.setCellWidget(row, 5, optional_check)

    def add_custom_to_table(self, component):
        """–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ —Ç–∞–±–ª–∏—Ü—É"""
        row = self.custom_table.rowCount()
        self.custom_table.insertRow(row)

        self.custom_table.setItem(row, 0, QTableWidgetItem(
            component['component_name']
        ))
        self.custom_table.setItem(row, 1, QTableWidgetItem(
            component['component_group'] or "other"
        ))

        # –†–∞—Å—Ö–æ–¥
        consumption_spin = QDoubleSpinBox()
        consumption_spin.setMinimum(0)
        consumption_spin.setMaximum(1000)
        consumption_spin.setDecimals(3)
        consumption_spin.setValue(
            float(component['absolute_consumption'] or 0)
        )
        self.custom_table.setCellWidget(row, 2, consumption_spin)

        self.custom_table.setItem(row, 3, QTableWidgetItem(
            component['unit'] or ""
        ))
        self.custom_table.setItem(row, 4, QTableWidgetItem(
            component['notes'] or ""
        ))

    def add_cutting_part(self):
        """–î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å –∫—Ä–æ—è"""
        dialog = CuttingPartSelectionDialog(self.cutting_parts, self)
        if dialog.exec():
            selected = dialog.get_selected()
            if selected:
                row = self.cutting_table.rowCount()
                self.cutting_table.insertRow(row)

                self.cutting_table.setItem(row, 0, QTableWidgetItem(selected['code']))
                self.cutting_table.setItem(row, 1, QTableWidgetItem(selected['name']))

                qty_spin = QSpinBox()
                qty_spin.setMinimum(1)
                qty_spin.setMaximum(100)
                qty_spin.setValue(selected['default_qty'] or 1)
                self.cutting_table.setCellWidget(row, 2, qty_spin)

                self.cutting_table.setItem(row, 3, QTableWidgetItem(selected['unit'] or "—à—Ç"))
                self.cutting_table.setItem(row, 4, QTableWidgetItem(selected['notes'] or ""))

    def remove_cutting_part(self):
        """–£–¥–∞–ª–∏—Ç—å –¥–µ—Ç–∞–ª—å –∫—Ä–æ—è"""
        row = self.cutting_table.currentRow()
        if row >= 0:
            self.cutting_table.removeRow(row)

    def add_material(self):
        """–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª"""
        dialog = MaterialSelectionDialog(self.materials, self)
        if dialog.exec():
            selected = dialog.get_selected()
            if selected:
                row = self.materials_table.rowCount()
                self.materials_table.insertRow(row)

                self.materials_table.setItem(row, 0, QTableWidgetItem(selected['code']))
                self.materials_table.setItem(row, 1, QTableWidgetItem(selected['name']))

                percent_spin = QDoubleSpinBox()
                percent_spin.setMinimum(0)
                percent_spin.setMaximum(200)
                percent_spin.setSuffix(" %")
                self.materials_table.setCellWidget(row, 2, percent_spin)

                abs_spin = QDoubleSpinBox()
                abs_spin.setMinimum(0)
                abs_spin.setMaximum(1000)
                abs_spin.setDecimals(3)
                self.materials_table.setCellWidget(row, 3, abs_spin)

                self.materials_table.setItem(row, 4, QTableWidgetItem(selected['unit'] or ""))

                optional_check = QCheckBox()
                self.materials_table.setCellWidget(row, 5, optional_check)

    def remove_material(self):
        """–£–¥–∞–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª"""
        row = self.materials_table.currentRow()
        if row >= 0:
            self.materials_table.removeRow(row)

    def add_custom_component(self):
        """–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç"""
        row = self.custom_table.rowCount()
        self.custom_table.insertRow(row)

        self.custom_table.setItem(row, 0, QTableWidgetItem(""))
        self.custom_table.setItem(row, 1, QTableWidgetItem("other"))

        consumption_spin = QDoubleSpinBox()
        consumption_spin.setMinimum(0)
        consumption_spin.setMaximum(1000)
        consumption_spin.setDecimals(3)
        self.custom_table.setCellWidget(row, 2, consumption_spin)

        self.custom_table.setItem(row, 3, QTableWidgetItem(""))
        self.custom_table.setItem(row, 4, QTableWidgetItem(""))

    def remove_custom_component(self):
        """–£–¥–∞–ª–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç"""
        row = self.custom_table.currentRow()
        if row >= 0:
            self.custom_table.removeRow(row)

    def save_components(self):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã"""
        try:
            conn = self.db.get_connection()
            if not conn:
                return

            cursor = conn.cursor()

            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            cursor.execute("DELETE FROM model_components WHERE model_id = %s", (self.model_id,))

            sort_order = 0

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ç–∞–ª–∏ –∫—Ä–æ—è
            for row in range(self.cutting_table.rowCount()):
                name = self.cutting_table.item(row, 1).text()
                qty_widget = self.cutting_table.cellWidget(row, 2)
                qty = qty_widget.value() if qty_widget else 1
                unit = self.cutting_table.item(row, 3).text()
                notes = self.cutting_table.item(row, 4).text()

                cursor.execute("""
                    INSERT INTO model_components
                    (model_id, component_name, component_group, absolute_consumption,
                     unit, notes, sort_order)
                    VALUES (%s, %s, %s, %s, %s, %s, %s)
                """, (self.model_id, name, 'cutting', qty, unit, notes, sort_order))
                sort_order += 1

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã
            for row in range(self.materials_table.rowCount()):
                name = self.materials_table.item(row, 1).text()
                percent_widget = self.materials_table.cellWidget(row, 2)
                percent = percent_widget.value() if percent_widget else 0
                abs_widget = self.materials_table.cellWidget(row, 3)
                abs_val = abs_widget.value() if abs_widget else 0
                unit = self.materials_table.item(row, 4).text()
                optional_widget = self.materials_table.cellWidget(row, 5)
                is_optional = optional_widget.isChecked() if optional_widget else False

                cursor.execute("""
                    INSERT INTO model_components
                    (model_id, component_name, component_group, consumption_percent,
                     absolute_consumption, unit, is_optional, sort_order)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
                """, (self.model_id, name, 'material', percent, abs_val, unit,
                      is_optional, sort_order))
                sort_order += 1

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            for row in range(self.custom_table.rowCount()):
                name = self.custom_table.item(row, 0).text()
                group = self.custom_table.item(row, 1).text()
                consumption_widget = self.custom_table.cellWidget(row, 2)
                consumption = consumption_widget.value() if consumption_widget else 0
                unit = self.custom_table.item(row, 3).text()
                notes = self.custom_table.item(row, 4).text()

                cursor.execute("""
                    INSERT INTO model_components
                    (model_id, component_name, component_group, absolute_consumption,
                     unit, notes, sort_order)
                    VALUES (%s, %s, %s, %s, %s, %s, %s)
                """, (self.model_id, name, group, consumption, unit, notes, sort_order))
                sort_order += 1

            conn.commit()
            cursor.close()
            self.db.put_connection(conn)

            QMessageBox.information(self, "–£—Å–ø–µ—à–Ω–æ", "–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")

        except Exception as e:
            QMessageBox.critical(self, "–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: {e}")

    def calculate_costs(self):
        """–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å"""
        total_material_cost = 0
        details = []

        try:
            conn = self.db.get_connection()
            if not conn:
                return

            cursor = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)

            # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
            for row in range(self.materials_table.rowCount()):
                name = self.materials_table.item(row, 1).text()
                abs_widget = self.materials_table.cellWidget(row, 3)
                consumption = abs_widget.value() if abs_widget else 0

                # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –º–∞—Ç–µ—Ä–∏–∞–ª–∞
                cursor.execute("""
                    SELECT price FROM materials
                    WHERE name = %s AND is_active = true
                """, (name,))
                result = cursor.fetchone()

                if result and result['price']:
                    cost = float(result['price']) * consumption
                    total_material_cost += cost
                    details.append(f"{name}: {consumption:.3f} x {result['price']:.2f} = {cost:.2f}")

            cursor.close()
            self.db.put_connection(conn)

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            msg = f"–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: {total_material_cost:.2f} —Ä—É–±.\n\n"
            msg += "–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è:\n" + "\n".join(details)

            QMessageBox.information(self, "–†–∞—Å—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏", msg)

        except Exception as e:
            QMessageBox.critical(self, "–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å: {e}")


class CuttingPartSelectionDialog(QDialog):
    """–î–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ –¥–µ—Ç–∞–ª–∏ –∫—Ä–æ—è"""

    def __init__(self, cutting_parts, parent=None):
        super().__init__(parent)
        self.cutting_parts = cutting_parts
        self.selected = None
        self.setup_ui()

    def setup_ui(self):
        self.setWindowTitle("–í—ã–±–æ—Ä –¥–µ—Ç–∞–ª–∏ –∫—Ä–æ—è")
        self.setModal(True)
        self.resize(600, 400)

        layout = QVBoxLayout(self)

        # –ü–æ–∏—Å–∫
        self.search = QLineEdit()
        self.search.setPlaceholderText("–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é...")
        self.search.textChanged.connect(self.filter_parts)
        layout.addWidget(self.search)

        # –¢–∞–±–ª–∏—Ü–∞
        self.table = QTableWidget()
        self.table.setColumnCount(4)
        self.table.setHorizontalHeaderLabels(["–ö–æ–¥", "–ù–∞–∑–≤–∞–Ω–∏–µ", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", "–ö–æ–ª-–≤–æ"])
        self.table.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.table.doubleClicked.connect(self.accept)

        self.populate_table()
        layout.addWidget(self.table)

        # –ö–Ω–æ–ø–∫–∏
        buttons = QHBoxLayout()
        self.btn_ok = QPushButton("–í—ã–±—Ä–∞—Ç—å")
        self.btn_cancel = QPushButton("–û—Ç–º–µ–Ω–∞")

        self.btn_ok.clicked.connect(self.accept)
        self.btn_cancel.clicked.connect(self.reject)

        buttons.addWidget(self.btn_ok)
        buttons.addWidget(self.btn_cancel)
        layout.addLayout(buttons)

    def populate_table(self):
        self.table.setRowCount(len(self.cutting_parts))
        for row, part in enumerate(self.cutting_parts):
            self.table.setItem(row, 0, QTableWidgetItem(part['code'] or ""))
            self.table.setItem(row, 1, QTableWidgetItem(part['name'] or ""))
            self.table.setItem(row, 2, QTableWidgetItem(part['category'] or ""))
            self.table.setItem(row, 3, QTableWidgetItem(str(part['default_qty'] or 1)))

    def filter_parts(self, text):
        for row in range(self.table.rowCount()):
            match = False
            for col in range(2):  # –ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –∏ –Ω–∞–∑–≤–∞–Ω–∏—é
                item = self.table.item(row, col)
                if item and text.lower() in item.text().lower():
                    match = True
                    break
            self.table.setRowHidden(row, not match)

    def accept(self):
        row = self.table.currentRow()
        if row >= 0:
            self.selected = self.cutting_parts[row]
        super().accept()

    def get_selected(self):
        return self.selected


class MaterialSelectionDialog(QDialog):
    """–î–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞"""

    def __init__(self, materials, parent=None):
        super().__init__(parent)
        self.materials = materials
        self.selected = None
        self.setup_ui()

    def setup_ui(self):
        self.setWindowTitle("–í—ã–±–æ—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–∞")
        self.setModal(True)
        self.resize(700, 400)

        layout = QVBoxLayout(self)

        # –ü–æ–∏—Å–∫
        self.search = QLineEdit()
        self.search.setPlaceholderText("–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é...")
        self.search.textChanged.connect(self.filter_materials)
        layout.addWidget(self.search)

        # –¢–∞–±–ª–∏—Ü–∞
        self.table = QTableWidget()
        self.table.setColumnCount(5)
        self.table.setHorizontalHeaderLabels(["–ö–æ–¥", "–ù–∞–∑–≤–∞–Ω–∏–µ", "–¢–∏–ø", "–ï–¥–∏–Ω–∏—Ü–∞", "–¶–µ–Ω–∞"])
        self.table.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.table.doubleClicked.connect(self.accept)

        self.populate_table()
        layout.addWidget(self.table)

        # –ö–Ω–æ–ø–∫–∏
        buttons = QHBoxLayout()
        self.btn_ok = QPushButton("–í—ã–±—Ä–∞—Ç—å")
        self.btn_cancel = QPushButton("–û—Ç–º–µ–Ω–∞")

        self.btn_ok.clicked.connect(self.accept)
        self.btn_cancel.clicked.connect(self.reject)

        buttons.addWidget(self.btn_ok)
        buttons.addWidget(self.btn_cancel)
        layout.addLayout(buttons)

    def populate_table(self):
        self.table.setRowCount(len(self.materials))
        for row, mat in enumerate(self.materials):
            self.table.setItem(row, 0, QTableWidgetItem(mat['code'] or ""))
            self.table.setItem(row, 1, QTableWidgetItem(mat['name'] or ""))
            self.table.setItem(row, 2, QTableWidgetItem(mat['material_type'] or ""))
            self.table.setItem(row, 3, QTableWidgetItem(mat['unit'] or ""))
            price = f"{mat['price']:.2f}" if mat['price'] else ""
            self.table.setItem(row, 4, QTableWidgetItem(price))

    def filter_materials(self, text):
        for row in range(self.table.rowCount()):
            match = False
            for col in range(2):  # –ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –∏ –Ω–∞–∑–≤–∞–Ω–∏—é
                item = self.table.item(row, col)
                if item and text.lower() in item.text().lower():
                    match = True
                    break
            self.table.setRowHidden(row, not match)

    def accept(self):
        row = self.table.currentRow()
        if row >= 0:
            self.selected = self.materials[row]
        super().accept()

    def get_selected(self):
        return self.selected